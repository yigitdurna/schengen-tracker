<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Schengen 90/180</title>
  <meta name="description" content="Days left in Schengen (90/180), with memory."/>
  <meta name="theme-color" content="#4da6ff"/>
  <link rel="manifest" href="manifest.json"/>
  <link rel="icon" type="image/png" href="icon.png"/>
  <style>
    :root { --bg:#f7f7f8; --card:#ffffff; --text:#111; --muted:#666; --border:#e6e6e6; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:var(--bg); color:var(--text); }
    .container { max-width: 760px; margin: 0 auto; padding: 16px; }
    h1 { font-size: 20px; margin: 0 0 10px; }
    .card { background: var(--card); border:1px solid var(--border); border-radius: 14px; padding:16px; box-shadow: 0 1px 2px rgba(0,0,0,0.04); }
    .muted { color:var(--muted); font-size:12px; }
    .big { font-size: 40px; font-weight: 800; }
    .row { display:flex; gap:8px; align-items:end; flex-wrap:wrap; }
    input[type="date"], input[type="text"], button { width:100%; padding:10px 12px; border:1px solid var(--border); background:white; border-radius: 10px; }
    button { background: #111; color:white; border:none; cursor:pointer; }
    button.secondary { background: #fff; color:#111; border:1px solid var(--border); }
    table { width:100%; border-collapse: collapse; font-size: 14px; }
    th, td { text-align:left; padding:8px 6px; border-top:1px solid var(--border); }
    .right { text-align:right; }
    .hidden { display:none; }
    .btns { display:flex; gap:8px; flex-wrap:wrap; }
    .checkbox { display:flex; gap:8px; align-items:center; font-size: 14px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Schengen 90/180</h1>

    <!-- Dashboard -->
    <div class="card">
      <div class="row">
        <div style="flex:1 1 220px;">
          <div class="muted">Reference date</div>
          <input type="date" id="refDate"/>
        </div>
        <div style="flex:1 1 160px;">
          <div class="muted">Days left</div>
          <div id="left" class="big">90</div>
        </div>
        <div style="flex:1 1 220px;">
          <div class="muted" id="headlineLabel">Next entry allowed</div>
          <div id="headlineValue" style="font-size: 20px; font-weight:700;">—</div>
          <div id="regain" class="muted" style="margin-top:4px;"></div>
        </div>
      </div>
    </div>

    <div style="height:8px;"></div>

    <!-- Add Trip -->
    <div class="card">
      <div class="row">
        <div style="flex:2 1 180px;">
          <div class="muted">Trip name (optional)</div>
          <input type="text" id="name" placeholder="e.g., Paris July"/>
        </div>
        <div style="flex:1 1 140px;">
          <div class="muted">Entry</div>
          <input type="date" id="entry"/>
        </div>
        <div style="flex:1 1 140px;">
          <div class="muted">Exit</div>
          <input type="date" id="exit"/>
        </div>
        <div style="flex:0 0 160px;">
          <div class="checkbox" style="margin-bottom:8px;">
            <input type="checkbox" id="ongoing"/>
            <label for="ongoing">Ongoing trip</label>
          </div>
          <button id="addBtn">Add trip</button>
        </div>
      </div>
      <div class="muted" style="margin-top:6px;">
        Tip: For an ongoing trip, tick “Ongoing trip” and leave Exit empty. The app will count up to the reference date and show “Must exit by”.
      </div>
      <div style="height:8px;"></div>
      <div class="btns">
        <button class="secondary" id="clearBtn">Clear all</button>
        <button class="secondary" id="exportBtn">Export JSON</button>
        <label class="secondary" style="padding:10px 12px; border-radius:10px; cursor:pointer;">
          Import JSON
          <input type="file" accept="application/json" id="importFile" class="hidden"/>
        </label>
      </div>
    </div>

    <div style="height:8px;"></div>

    <!-- Trip Log -->
    <div class="card">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <div style="font-weight:600;">Trip log</div>
      </div>
      <div id="noTrips" class="muted">No trips yet.</div>
      <table id="tripsTable" class="hidden">
        <thead><tr><th>Trip</th><th>Entry</th><th>Exit</th><th>Days</th><th></th></tr></thead>
        <tbody id="tripsBody"></tbody>
      </table>
    </div>
  </div>

<script>
(function(){
  const STORAGE_KEY = "schengen-trips-v3";

  const $ = (sel) => document.querySelector(sel);
  const refDateEl = $("#refDate");
  const leftEl = $("#left");
  const headlineLabelEl = $("#headlineLabel");
  const headlineValueEl = $("#headlineValue");
  const regainEl = $("#regain");
  const nameEl = $("#name");
  const entryEl = $("#entry");
  const exitEl = $("#exit");
  const ongoingEl = $("#ongoing");
  const addBtn = $("#addBtn");
  const clearBtn = $("#clearBtn");
  const exportBtn = $("#exportBtn");
  const importFile = $("#importFile");
  const tripsTable = $("#tripsTable");
  const tripsBody = $("#tripsBody");
  const noTrips = $("#noTrips");

  function toYMD(d){ const y=d.getUTCFullYear(), m=String(d.getUTCMonth()+1).padStart(2,'0'), day=String(d.getUTCDate()).padStart(2,'0'); return `${y}-${m}-${day}`; }
  function fromYMD(s){ const [y,m,d]=s.split('-').map(Number); return new Date(Date.UTC(y, m-1, d)); }
  function todayUTC(){ const now=new Date(); return new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate())); }
  function addDaysUTC(d,n){ const t=new Date(d.getTime()); t.setUTCDate(t.getUTCDate()+n); return t; }
  function eachDateInclusiveUTC(start,end){ const out=[]; let cur=new Date(start.getTime()); while(cur.getTime()<=end.getTime()){ out.push(toYMD(cur)); cur=addDaysUTC(cur,1);} return out; }

  function overlappingDays(trips, start, end){
    const days=new Set();
    for(const t of trips){
      if(!t.entry) continue;
      const a=fromYMD(t.entry);
      const b=t.exit ? fromYMD(t.exit) : end;
      if(a.getTime()>end.getTime() || b.getTime()<start.getTime()) continue;
      const s=a.getTime()<start.getTime()?start:a;
      const e=b.getTime()>end.getTime()?end:b;
      for(const d of eachDateInclusiveUTC(s,e)) days.add(d);
    }
    return days.size;
  }
  function rollingUsed(trips,onDate){
    const windowStart=addDaysUTC(onDate,-179);
    return overlappingDays(trips, windowStart, onDate);
  }
  function nextAllowedEntryDate(trips, fromDate){
    const used=rollingUsed(trips, fromDate);
    if(used<90) return "You can enter now";
    for(let i=0;i<365;i++){ const d=addDaysUTC(fromDate,i); if(rollingUsed(trips,d)<90) return toYMD(d); }
    return null;
  }
  function nextRegainDate(trips, fromDate){
    const base=rollingUsed(trips, fromDate);
    for(let i=1;i<=365;i++){ const d=addDaysUTC(fromDate,i); if(rollingUsed(trips,d)<base) return toYMD(d); }
    return null;
  }
  function mustExitBy(trips, fromDate){
    let lastOK=null;
    for(let i=0;i<730;i++){
      const d=addDaysUTC(fromDate,i);
      const used=rollingUsed(trips,d);
      if(used<=90){ lastOK=d; } else { break; }
    }
    return lastOK ? toYMD(lastOK) : null;
  }

  let trips=[];
  function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(trips)); }
  function load(){ try{ trips=JSON.parse(localStorage.getItem(STORAGE_KEY))||[]; }catch{ trips=[]; } }

  function renderTrips(){
    trips.sort((a,b)=> a.entry.localeCompare(b.entry) || (a.name||'').localeCompare(b.name||''));
    tripsBody.innerHTML="";
    if(trips.length===0){ tripsTable.classList.add("hidden"); noTrips.classList.remove("hidden"); return; }
    tripsTable.classList.remove("hidden"); noTrips.classList.add("hidden");
    for(const t of trips){
      const entry=fromYMD(t.entry);
      const exit=t.exit?fromYMD(t.exit):entry;
      const days = t.exit ? eachDateInclusiveUTC(entry, exit).length : "—";
      const tr=document.createElement("tr");
      tr.innerHTML = `<td>${t.name||'—'}${t.exit?'':' <span class="muted">(ongoing)</span>'}</td>
                      <td>${t.entry}</td>
                      <td>${t.exit || '—'}</td>
                      <td>${days}</td>
                      <td class="right"><button class="secondary del">Delete</button></td>`;
      tr.querySelector(".del").addEventListener("click", ()=>{
        trips = trips.filter(x => !(x.entry===t.entry && (x.exit||'')===(t.exit||'') && (x.name||'')===(t.name||'')));
        save(); update();
      });
      tripsBody.appendChild(tr);
    }
  }

  function renderStats(){
    const ref=fromYMD(refDateEl.value);
    const used=rollingUsed(trips, ref);
    leftEl.textContent=Math.max(0, 90-used);

    const hasOngoing = trips.some(t => t.entry && !t.exit && fromYMD(t.entry).getTime()<=ref.getTime());
    if(hasOngoing){
      headlineLabelEl.textContent="Must exit by";
      const mustBy = mustExitBy(trips, ref);
      headlineValueEl.textContent = mustBy || "—";
      regainEl.textContent = "";
    } else {
      headlineLabelEl.textContent="Next entry allowed";
      headlineValueEl.textContent = nextAllowedEntryDate(trips, ref) || "—";
      const regain = nextRegainDate(trips, ref);
      regainEl.textContent = regain ? ("Next day regained: " + regain) : "";
    }
  }

  function update(){ renderTrips(); renderStats(); }

  addBtn.addEventListener("click", ()=>{
    const nm=nameEl.value.trim();
    const en=entryEl.value, ex=exitEl.value;
    const isOngoing=ongoingEl.checked;

    if(!en) return alert("Pick an entry date.");
    if(!isOngoing && !ex) return alert("Pick an exit date or mark as ongoing.");
    if(!isOngoing && fromYMD(ex).getTime() < fromYMD(en).getTime()) return alert("Exit must be on/after entry.");

    trips.push({ name: nm || null, entry: en, exit: isOngoing ? null : ex || null });
    nameEl.value=""; entryEl.value=""; exitEl.value=""; ongoingEl.checked=false;
    save(); update();
  });
  clearBtn.addEventListener("click", ()=>{ if(confirm("Delete all trips?")){ trips=[]; save(); update(); }});
  exportBtn.addEventListener("click", ()=>{
    const blob=new Blob([JSON.stringify(trips, null, 2)], {type:"application/json"});
    const url=URL.createObjectURL(blob); const a=document.createElement("a");
    a.href=url; a.download="schengen_trips.json"; a.click(); URL.revokeObjectURL(url);
  });
  importFile.addEventListener("change", (e)=>{
    const file=e.target.files && e.target.files[0]; if(!file) return;
    file.text().then(txt=>{
      try{
        const data=JSON.parse(txt);
        if(!Array.isArray(data)) throw new Error("Invalid format");
        trips=data.map(d=>({ name:d.name||null, entry:d.entry, exit:d.exit??null }))
                  .filter(d=>d.entry);
        save(); update();
      }catch(err){ alert("Import failed: " + (err && err.message || err)); }
    });
  });

  load();
  const t=todayUTC();
  refDateEl.value=toYMD(t);
  update();
})();
</script>
</body>
</html>